version: 2.1

executors:
  bun_executor:
    docker:
      - image: oven/bun:latest
    working_directory: ~/project
    environment:
      NODE_MODULES_CHECK_PATH: node_modules
      BUN_LOCK_FILE: bun.lockb
      DIST_FOLDER: dist
      GITHUB_API_BASE: https://api.github.com/repos/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME

commands:
  checkout_code:
    description: "Checkout code from GitHub"
    steps:
      - checkout
      - run:
          name: Set Git Commit SHA
          command: echo "export GIT_COMMIT=$CIRCLE_SHA1" >> $BASH_ENV
      - run:
          name: Log Branch and Commit
          command: |
            echo "üìå Trabajando con la rama: $CIRCLE_BRANCH"
            echo "üìå Commit SHA: $GIT_COMMIT"

  install_curl:
    description: "Install curl in the Docker image"
    steps:
      - run:
          name: Install curl
          command: |
            if command -v apk >/dev/null 2>&1; then
              apk add --no-cache curl
            elif command -v apt-get >/dev/null 2>&1; then
              apt-get update && apt-get install -y curl
            else
              echo "No supported package manager found (apk or apt-get)"
              exit 1
            fi

  notify_github:
    description: "Send status to GitHub"
    parameters:
      status:
        type: string
      description:
        type: string
    steps:
      - install_curl
      - run:
          name: Send GitHub Status
          command: |
            curl -X POST \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME/statuses/$GIT_COMMIT \
              -d "{\"state\": \"<< parameters.status >>\", \"description\": \"<< parameters.description >>\", \"context\": \"CI/CD\", \"target_url\": \"$CIRCLE_BUILD_URL\"}"

jobs:
  clone_repository:
    executor: bun_executor
    steps:
      - checkout_code

  check_bun_version:
    executor: bun_executor
    steps:
      - checkout_code
      - run:
          name: Check Bun Version
          command: bun --version

  install_dependencies:
    executor: bun_executor
    steps:
      - checkout_code
      - run:
          name: Install Dependencies
          command: |
            rm -rf node_modules
            rm -f $BUN_LOCK_FILE
            bun install
      - persist_to_workspace:
          root: .
          paths:
            - node_modules
            - bun.lockb
            - package.json

  run_unit_tests:
    executor: bun_executor
    parallelism: 1
    steps:
      - checkout_code
      - attach_workspace:
          at: .
      - run:
          name: Run Tests with Bun
          command: |
            mkdir -p test-results/jest
            mkdir -p coverage
            bun test --coverage || exit 1
      - store_test_results:
          path: test-results
      - store_artifacts:
          path: coverage
      - when:
          condition: on_fail
          steps:
            - notify_github:
                status: failure
                description: "‚ùå Unit tests failed"

  code_quality_analysis:
    executor: bun_executor
    steps:
      - checkout_code
      - attach_workspace:
          at: .
      - run:
          name: Code Quality Analysis
          command: |
            bun run lint || echo "‚ö† Linting issues found"
      - store_artifacts:
          path: eslint-report.xml
      - when:
          condition: on_fail
          steps:
            - notify_github:
                status: failure
                description: "‚ùå Linting failed"

  build_application:
    executor: bun_executor
    steps:
      - checkout_code
      - attach_workspace:
          at: .
      - run:
          name: Build Application
          command: bun run build
      - persist_to_workspace:
          root: .
          paths:
            - dist
      - when:
          condition: on_fail
          steps:
            - notify_github:
                status: failure
                description: "‚ùå Build failed"

  deploy_to_production:
    executor: bun_executor
    steps:
      - checkout_code
      - attach_workspace:
          at: .
      - run:
          name: Check dist folder
          command: |
            if [ -d dist ]; then
              echo "dist folder ready"
            else
              echo "dist folder not found"
              exit 1
            fi
      - store_artifacts:
          path: dist
          destination: deploy-output
      - run:
          name: Log Deployment
          command: touch /tmp/deploy_success
      - when:
          condition: on_fail
          steps:
            - notify_github:
                status: failure
                description: "‚ùå Deployment failed"

  post_notifications:
    executor: bun_executor
    steps:
      - install_curl
      - run:
          name: Send GitHub Notification
          command: |
            STATUS="failure"
            DESCRIPTION="‚ùå Pipeline failed"
            if [ -f /tmp/deploy_success ]; then
              STATUS="success"
              DESCRIPTION="‚úÖ Build passed from CircleCI"
            fi
            curl -X POST \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME/statuses/$GIT_COMMIT \
              -d "{\"state\": \"$STATUS\", \"description\": \"$DESCRIPTION\", \"context\": \"CI/CD\", \"target_url\": \"$CIRCLE_BUILD_URL\"}"

workflows:
  build_test_deploy:
    jobs:
      - clone_repository:
          filters:
            branches:
              only: main
      - check_bun_version:
          requires:
            - clone_repository
          filters:
            branches:
              only: main
      - install_dependencies:
          requires:
            - check_bun_version
          filters:
            branches:
              only: main
      - run_unit_tests:
          requires:
            - install_dependencies
          filters:
            branches:
              only: main
      - code_quality_analysis:
          requires:
            - install_dependencies
          filters:
            branches:
              only: main
      - build_application:
          requires:
            - run_unit_tests
            - code_quality_analysis
          filters:
            branches:
              only: main
      - deploy_to_production:
          requires:
            - build_application
          filters:
            branches:
              only: main
      - post_notifications:
          requires:
            - deploy_to_production
          filters:
            branches:
              only: main
